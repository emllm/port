FROM node:18-slim AS builder
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY tsconfig.json ./

# Install dependencies
RUN npm install

# Copy source code
COPY src ./src

# Build the application
RUN npm run build

# Production stage
FROM electron:27-alpine
WORKDIR /app

# Install Tauri dependencies
RUN apk add --no-cache \
    libxcb libxkbcommon libxrender libx11 libxext libxinerama libxcursor \
    libxrandr libxcomposite libxdamage libxfixes libxscrnsaver libxss \
    libxft libxpm libxmu libxmuu libxi libgl libegl libgles mesa-gl \
    mesa-egl mesa-gles mesa-dri mesa-dri-llvm mesa-dri-swrast mesa-dri-intel \
    mesa-dri-nouveau mesa-dri-radeon mesa-dri-vmware mesa-dri-vmware-llvm \
    mesa-dri-vmware-llvm-64 mesa-dri-vmware-llvm-32 mesa-dri-vmware-llvm-64-32 \
    mesa-dri-vmware-llvm-32-64 mesa-dri-vmware-llvm-32-32 mesa-dri-vmware-llvm-64-64

# Copy built files from builder stage
COPY --from=builder /app/dist /app/dist

# Expose default port
EXPOSE 8080

# Start the application
CMD ["npm", "start"]
